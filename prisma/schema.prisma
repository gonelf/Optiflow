// OptiVibe Database Schema
// PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// AUTH & WORKSPACE MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  onboarded     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  workspaces        WorkspaceMember[]
  pages             Page[]
  sessions          Session[]
  apiKeys           ApiKey[]
  analyticsSessions AnalyticsSession[]
  accounts          Account[]

  @@index([email])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Workspace {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  plan          PlanType  @default(FREE)
  stripeCustomerId String?
  stripeSubscriptionId String?
  domain        String?   // Custom domain
  startingPageId String?  // The default/home page for this workspace
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  members       WorkspaceMember[]
  pages         Page[]
  startingPage  Page?     @relation("StartingPage", fields: [startingPageId], references: [id], onDelete: SetNull)
  templates     Template[]
  integrations  Integration[]
  analytics     AnalyticsSession[]
  webhooks      Webhook[]
  designSystem  DesignSystem?
  customFonts   CustomFont[]
  customDomains CustomDomain[]

  @@index([slug])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  role        Role     @default(MEMBER)
  userId      String
  workspaceId String
  joinedAt    DateTime @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

// ============================================================================
// PAGE BUILDER & COMPONENTS
// ============================================================================

model Page {
  id            String      @id @default(cuid())
  title         String
  slug          String
  description   String?
  status        PageStatus  @default(DRAFT)
  isTemplate    Boolean     @default(false)

  // Metadata
  seoTitle      String?
  seoDescription String?
  ogImage       String?
  favicon       String?
  customHead    String?     @db.Text

  // Ownership
  workspaceId   String
  authorId      String

  // Publishing
  publishedAt   DateTime?
  publishedUrl  String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  author        User        @relation(fields: [authorId], references: [id])
  components    Component[]
  elements      Element[]
  variants      PageVariant[]
  abTests       ABTest[]
  analytics     AnalyticsSession[]
  versions      PageVersion[]
  translations  PageTranslation[]
  startingForWorkspaces Workspace[] @relation("StartingPage")

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([authorId])
  @@index([status])
  @@index([slug, status]) // Composite for published page lookup
  @@index([workspaceId, status]) // Composite for workspace page filtering
  @@index([status, publishedAt]) // Composite for published page ordering
}

model Component {
  id            String      @id @default(cuid())
  pageId        String
  variantId     String?     // If part of A/B variant

  // Component Definition
  type          ComponentType
  name          String
  order         Int         // Display order on page

  // Content (JSON schema)
  config        Json        // Component-specific config
  styles        Json        // Tailwind classes + custom styles
  content       Json        // Text, images, links, etc.

  // AI Metadata
  aiPrompt      String?     @db.Text
  aiGenerated   Boolean     @default(false)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  page          Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  variant       PageVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([variantId])
  @@index([type])
  @@index([pageId, order]) // Composite for ordered page components
  @@index([variantId, order]) // Composite for ordered variant components
}

enum ComponentType {
  HERO
  CTA
  PRICING
  FEATURES
  TESTIMONIALS
  FAQ
  FORM
  NEWSLETTER
  HEADER
  FOOTER
  CUSTOM
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Template {
  id            String      @id @default(cuid())
  name          String
  description   String?
  category      TemplateCategory
  thumbnail     String?
  isPremium     Boolean     @default(false)

  // Template Content (serialized page structure)
  structure     Json        @db.JsonB

  workspaceId   String?     // Null = global template
  workspace     Workspace?  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  usageCount    Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([category])
  @@index([workspaceId])
}

enum TemplateCategory {
  HERO
  LANDING_PAGE
  PRICING
  DEMO
  FUNNEL
  WAITLIST
  COMING_SOON
}

// ============================================================================
// A/B TESTING
// ============================================================================

model ABTest {
  id            String      @id @default(cuid())
  name          String
  description   String?
  pageId        String

  // Test Configuration
  status        TestStatus  @default(DRAFT)
  trafficSplit  Json        // { "control": 50, "variant_a": 25, "variant_b": 25 }
  startDate     DateTime?
  endDate       DateTime?

  // Goals & Metrics
  primaryGoal   String      // e.g., "form_submit", "button_click"
  conversionEvent String

  // Statistical Config
  minimumSampleSize Int     @default(1000)
  confidenceLevel Float     @default(0.95)

  // Results
  winningVariantId String?
  declaredAt    DateTime?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  page          Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  variants      PageVariant[]
  winningVariant PageVariant? @relation("WinningVariant", fields: [winningVariantId], references: [id])

  @@index([pageId])
  @@index([status])
}

model PageVariant {
  id            String      @id @default(cuid())
  name          String
  description   String?
  isControl     Boolean     @default(false)

  abTestId      String
  pageId        String

  // Variant-specific components
  components    Component[]
  elements      Element[]

  // Metrics (denormalized for performance)
  impressions   Int         @default(0)
  conversions   Int         @default(0)
  conversionRate Float      @default(0)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  abTest        ABTest      @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  page          Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  events        AnalyticsEvent[]
  wonTests      ABTest[]    @relation("WinningVariant")

  @@index([abTestId])
  @@index([pageId])
  @@index([abTestId, isControl]) // Composite for finding control variant
  @@index([abTestId, conversionRate]) // Composite for performance comparison
}

enum TestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  ARCHIVED
}

// ============================================================================
// ANALYTICS & TRACKING
// ============================================================================

model AnalyticsSession {
  id            String      @id @default(cuid())
  sessionId     String      @unique

  // Visitor Info
  visitorId     String      // Fingerprint/anonymous ID
  userId        String?     // If authenticated

  // Page Context
  pageId        String
  workspaceId   String
  variantId     String?     // A/B variant shown

  // Session Metadata
  referrer      String?
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?

  // Device/Browser
  userAgent     String?
  browser       String?
  os            String?
  device        String?
  country       String?
  city          String?

  // Session Metrics
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  duration      Int?        // seconds

  // Relations
  page          Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user          User?       @relation(fields: [userId], references: [id])
  events        AnalyticsEvent[]

  @@index([sessionId])
  @@index([visitorId])
  @@index([pageId])
  @@index([workspaceId])
  @@index([startedAt])
  @@index([workspaceId, startedAt]) // Composite for time-range analytics
  @@index([pageId, startedAt]) // Composite for page analytics over time
  @@index([variantId, startedAt]) // Composite for A/B test analytics
}

model AnalyticsEvent {
  id            String      @id @default(cuid())

  // Event Details
  eventType     EventType
  eventName     String
  eventData     Json?       // Custom event properties

  // Context
  sessionId     String
  variantId     String?

  // Element Tracking
  elementId     String?
  elementType   String?     // button, link, form, etc.
  elementText   String?

  // Position Tracking (for heatmaps)
  xPosition     Int?
  yPosition     Int?
  scrollDepth   Int?        // percentage

  // Conversion Tracking
  isConversion  Boolean     @default(false)
  conversionValue Float?    // Revenue if applicable

  timestamp     DateTime    @default(now())

  // Relations
  session       AnalyticsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  variant       PageVariant?     @relation(fields: [variantId], references: [id])

  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
  @@index([isConversion])
  @@index([sessionId, eventType]) // Composite for filtering events by session
  @@index([eventType, timestamp]) // Composite for event analytics over time
  @@index([isConversion, timestamp]) // Composite for conversion tracking
  @@index([variantId, isConversion]) // Composite for A/B test conversions
}

enum EventType {
  PAGE_VIEW
  CLICK
  FORM_SUBMIT
  SCROLL
  TIME_ON_PAGE
  CONVERSION
  CUSTOM
}

// ============================================================================
// AI & PERSONALIZATION
// ============================================================================

model AIOptimization {
  id            String      @id @default(cuid())
  type          OptimizationType

  // Input
  prompt        String      @db.Text
  context       Json?       // Page context, user data, etc.

  // Output
  suggestions   Json        @db.JsonB // Generated variants, SEO, etc.
  applied       Boolean     @default(false)

  // Metadata
  model         String      // e.g., "gpt-4"
  tokensUsed    Int?

  createdAt     DateTime    @default(now())

  @@index([type])
  @@index([createdAt])
}

enum OptimizationType {
  VARIANT_GENERATION
  SEO_OPTIMIZATION
  CONTENT_PERSONALIZATION
  HEADLINE_SUGGESTIONS
  CTA_OPTIMIZATION
}

model PersonalizationRule {
  id            String      @id @default(cuid())
  name          String

  // Targeting
  segment       Json        // Visitor criteria
  priority      Int         @default(0)

  // Action
  action        PersonalizationAction
  config        Json        // What to change

  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([isActive])
}

enum PersonalizationAction {
  SWAP_COMPONENT
  CHANGE_TEXT
  CHANGE_IMAGE
  REDIRECT
  SHOW_BANNER
}

// ============================================================================
// INTEGRATIONS
// ============================================================================

model Integration {
  id            String          @id @default(cuid())
  workspaceId   String
  type          IntegrationType

  // Config
  name          String
  config        Json            // API keys, settings, etc.
  isActive      Boolean         @default(true)

  // Sync Status
  lastSyncAt    DateTime?
  lastError     String?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([type])
}

enum IntegrationType {
  STRIPE
  HUBSPOT
  SALESFORCE
  MAILCHIMP
  ZAPIER
  WEBHOOK
  GOOGLE_ANALYTICS
  FACEBOOK_PIXEL
}

// ============================================================================
// SYSTEM
// ============================================================================

model ApiKey {
  id            String      @id @default(cuid())
  key           String      @unique
  name          String
  userId        String
  lastUsedAt    DateTime?
  expiresAt     DateTime?

  createdAt     DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
}

model Session {
  id            String      @id @default(cuid())
  userId        String
  token         String      @unique
  expiresAt     DateTime
  createdAt     DateTime    @default(now())

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============================================================================
// WEBHOOKS
// ============================================================================

model Webhook {
  id          String   @id @default(cuid())
  url         String
  events      String[]
  secret      String?
  active      Boolean  @default(true)
  workspaceId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]

  @@index([workspaceId])
}

model WebhookDelivery {
  id              String   @id @default(cuid())
  webhookId       String
  event           String
  payload         Json
  status          String
  attempts        Int      @default(0)
  lastAttemptAt   DateTime?
  responseStatus  Int?
  responseBody    String?  @db.Text
  error           String?  @db.Text
  createdAt       DateTime @default(now())

  webhook         Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([webhookId, status]) // Composite for filtering deliveries by status
  @@index([webhookId, createdAt]) // Composite for delivery history
  @@index([status, lastAttemptAt]) // Composite for retry processing
}

// ============================================================================
// PHASE 7: ADVANCED FEATURES
// ============================================================================

// VERSION HISTORY & ROLLBACK
model PageVersion {
  id              String      @id @default(cuid())
  pageId          String
  versionNumber   Int

  // Version Content
  title           String
  description     String?
  content         Json        @db.JsonB // Snapshot of all components
  metadata        Json?       // SEO, custom head, etc.

  // Change Tracking
  changeType      ChangeType  @default(MANUAL_SAVE)
  changeSummary   String?
  changedBy       String      // User ID

  // Restore Status
  isRestorePoint  Boolean     @default(false)

  createdAt       DateTime    @default(now())

  // Relations
  page            Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, versionNumber])
  @@index([pageId])
  @@index([pageId, createdAt]) // For version history listing
  @@index([pageId, versionNumber]) // For quick version lookup
}

enum ChangeType {
  MANUAL_SAVE
  AUTO_SAVE
  PUBLISHED
  ROLLBACK
  COLLABORATION_MERGE
}

// REAL-TIME COLLABORATION
model CollaborationSession {
  id              String      @id @default(cuid())
  pageId          String
  userId          String

  // Session Info
  userName        String
  userAvatar      String?
  color           String      // Unique color for cursor/presence

  // Presence
  isActive        Boolean     @default(true)
  lastSeenAt      DateTime    @default(now())

  // Cursor Position
  cursorX         Int?
  cursorY         Int?
  selectedComponentId String?

  // Connection
  socketId        String?

  startedAt       DateTime    @default(now())
  endedAt         DateTime?

  @@index([pageId])
  @@index([pageId, isActive]) // For active collaborators
  @@index([userId])
  @@index([socketId])
}

model PageEdit {
  id              String      @id @default(cuid())
  pageId          String
  componentId     String?     // Null if page-level edit
  userId          String

  // Edit Details
  editType        EditType
  path            String      // JSON path to changed field
  oldValue        Json?
  newValue        Json?

  // Conflict Resolution
  version         Int         // Optimistic locking version
  appliedAt       DateTime?
  conflicted      Boolean     @default(false)
  resolvedBy      String?     // User ID who resolved conflict

  createdAt       DateTime    @default(now())

  @@index([pageId])
  @@index([pageId, createdAt]) // For edit history
  @@index([componentId])
  @@index([userId])
}

enum EditType {
  COMPONENT_ADD
  COMPONENT_UPDATE
  COMPONENT_DELETE
  COMPONENT_REORDER
  PAGE_UPDATE
  STYLE_UPDATE
  CONTENT_UPDATE
}

// MULTI-LANGUAGE SUPPORT
model PageTranslation {
  id              String      @id @default(cuid())
  pageId          String
  locale          String      // e.g., "en", "es", "fr"

  // Translated Content
  title           String
  description     String?
  seoTitle        String?
  seoDescription  String?
  components      Json        @db.JsonB // Component translations

  // Translation Status
  status          TranslationStatus @default(DRAFT)
  translatedBy    String?     // User ID or "AI"
  reviewedBy      String?     // User ID

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  page            Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, locale])
  @@index([pageId])
  @@index([locale])
  @@index([status])
}

enum TranslationStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
}

model SupportedLocale {
  id              String      @id @default(cuid())
  workspaceId     String

  // Locale Info
  code            String      // e.g., "en", "es", "fr"
  name            String      // e.g., "English", "Spanish"
  isDefault       Boolean     @default(false)
  isEnabled       Boolean     @default(true)

  createdAt       DateTime    @default(now())

  @@unique([workspaceId, code])
  @@index([workspaceId])
  @@index([workspaceId, isEnabled])
}

// ============================================================================
// PHASE 8: VISUAL CSS & PRIMITIVES
// ============================================================================

// ELEMENT MODEL - Enhanced component system for visual builder
model Element {
  id            String      @id @default(cuid())
  pageId        String
  variantId     String?

  // Element Definition
  type          String      // PrimitiveType or ComponentType
  name          String
  order         Int

  // Hierarchy
  parentId      String?     // Parent element ID for nesting
  depth         Int         @default(0)
  path          String      // Materialized path for tree queries

  // Content & Styles
  content       Json        @db.JsonB
  styles        Json        @db.JsonB  // ResponsiveStyles
  stateStyles   Json?       @db.JsonB  // Hover/focus/active styles

  // Metadata
  locked        Boolean     @default(false)
  hidden        Boolean     @default(false)
  className     String?
  attributes    Json?

  // AI
  aiPrompt      String?     @db.Text
  aiGenerated   Boolean     @default(false)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  page          Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  variant       PageVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  parent        Element?    @relation("ElementHierarchy", fields: [parentId], references: [id])
  children      Element[]   @relation("ElementHierarchy")

  @@index([pageId])
  @@index([parentId])
  @@index([pageId, order])
  @@index([path])
}

// DESIGN SYSTEM - Design tokens per workspace
model DesignSystem {
  id            String    @id @default(cuid())
  workspaceId   String    @unique
  name          String    @default("Default")

  // Token Values
  colors        Json      @db.JsonB
  typography    Json      @db.JsonB
  spacing       Json      @db.JsonB
  borderRadius  Json      @db.JsonB
  shadows       Json      @db.JsonB
  breakpoints   Json      @db.JsonB

  // Custom CSS Variables
  customTokens  Json?     @db.JsonB

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

// CUSTOM DOMAINS
enum CustomDomainStatus {
  PENDING
  ACTIVE
  FAILED
}

model CustomDomain {
  id          String             @id @default(cuid())
  workspaceId String
  domain      String             @unique
  status      CustomDomainStatus @default(PENDING)
  dnsRecords  Json?              // Verification DNS records returned by Vercel
  verifiedAt  DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([domain])
}

// CUSTOM FONTS
model CustomFont {
  id            String    @id @default(cuid())
  workspaceId   String
  name          String
  family        String
  weight        Int[]
  style         String[]  // normal, italic

  // Font Files
  woff2Url      String?
  woffUrl       String?
  ttfUrl        String?

  createdAt     DateTime  @default(now())

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, family])
  @@index([workspaceId])
}
