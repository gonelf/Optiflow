generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String?
  avatarUrl         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  onboarded         Boolean            @default(false)
  systemRole        SystemRole         @default(USER)
  accounts          Account[]
  analyticsSessions AnalyticsSession[]
  apiKeys           ApiKey[]
  pages             Page[]
  sessions          Session[]
  workspaces        WorkspaceMember[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Workspace {
  id                   String             @id @default(cuid())
  name                 String
  slug                 String             @unique
  plan                 PlanType           @default(FREE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  domain               String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  startingPageId       String?
  analytics            AnalyticsSession[]
  customDomains        CustomDomain[]
  customFonts          CustomFont[]
  designSystem         DesignSystem?
  integrations         Integration[]
  pages                Page[]
  templates            Template[]
  webhooks             Webhook[]
  startingPage         Page?              @relation("StartingPage", fields: [startingPageId], references: [id])
  members              WorkspaceMember[]

  @@index([slug])
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  role        Role      @default(MEMBER)
  userId      String
  workspaceId String
  joinedAt    DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

model Page {
  id                    String             @id @default(cuid())
  title                 String
  slug                  String
  description           String?
  status                PageStatus         @default(DRAFT)
  isTemplate            Boolean            @default(false)
  seoTitle              String?
  seoDescription        String?
  ogImage               String?
  favicon               String?
  customHead            String?
  workspaceId           String
  authorId              String
  publishedAt           DateTime?
  publishedUrl          String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  abTests               ABTest[]
  analytics             AnalyticsSession[]
  components            Component[]
  elements              Element[]
  author                User               @relation(fields: [authorId], references: [id])
  workspace             Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  translations          PageTranslation[]
  variants              PageVariant[]
  versions              PageVersion[]
  startingForWorkspaces Workspace[]        @relation("StartingPage")

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([authorId])
  @@index([status])
  @@index([slug, status])
  @@index([workspaceId, status])
  @@index([status, publishedAt])
}

model Component {
  id          String        @id @default(cuid())
  pageId      String
  variantId   String?
  type        ComponentType
  name        String
  order       Int
  config      Json
  styles      Json
  content     Json
  aiPrompt    String?
  aiGenerated Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  page        Page          @relation(fields: [pageId], references: [id], onDelete: Cascade)
  variant     PageVariant?  @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([variantId])
  @@index([type])
  @@index([pageId, order])
  @@index([variantId, order])
}

model Template {
  id          String           @id @default(cuid())
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String?
  isPremium   Boolean          @default(false)
  structure   Json
  workspaceId String?
  usageCount  Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  workspace   Workspace?       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([workspaceId])
}

model ABTest {
  id                String        @id @default(cuid())
  name              String
  description       String?
  pageId            String
  status            TestStatus    @default(DRAFT)
  trafficSplit      Json
  startDate         DateTime?
  endDate           DateTime?
  primaryGoal       String
  conversionEvent   String
  minimumSampleSize Int           @default(1000)
  confidenceLevel   Float         @default(0.95)
  winningVariantId  String?
  declaredAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  page              Page          @relation(fields: [pageId], references: [id], onDelete: Cascade)
  winningVariant    PageVariant?  @relation("WinningVariant", fields: [winningVariantId], references: [id])
  variants          PageVariant[]

  @@index([pageId])
  @@index([status])
}

model PageVariant {
  id             String           @id @default(cuid())
  name           String
  description    String?
  isControl      Boolean          @default(false)
  abTestId       String
  pageId         String
  impressions    Int              @default(0)
  conversions    Int              @default(0)
  conversionRate Float            @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  wonTests       ABTest[]         @relation("WinningVariant")
  events         AnalyticsEvent[]
  components     Component[]
  elements       Element[]
  abTest         ABTest           @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  page           Page             @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([abTestId])
  @@index([pageId])
  @@index([abTestId, isControl])
  @@index([abTestId, conversionRate])
}

model AnalyticsSession {
  id          String           @id @default(cuid())
  sessionId   String           @unique
  visitorId   String
  userId      String?
  pageId      String
  workspaceId String
  variantId   String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  userAgent   String?
  browser     String?
  os          String?
  device      String?
  country     String?
  city        String?
  startedAt   DateTime         @default(now())
  endedAt     DateTime?
  duration    Int?
  events      AnalyticsEvent[]
  page        Page             @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [userId], references: [id])
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([visitorId])
  @@index([pageId])
  @@index([workspaceId])
  @@index([startedAt])
  @@index([workspaceId, startedAt])
  @@index([pageId, startedAt])
  @@index([variantId, startedAt])
}

model AnalyticsEvent {
  id              String           @id @default(cuid())
  eventType       EventType
  eventName       String
  eventData       Json?
  sessionId       String
  variantId       String?
  elementId       String?
  elementType     String?
  elementText     String?
  xPosition       Int?
  yPosition       Int?
  scrollDepth     Int?
  isConversion    Boolean          @default(false)
  conversionValue Float?
  timestamp       DateTime         @default(now())
  session         AnalyticsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  variant         PageVariant?     @relation(fields: [variantId], references: [id])

  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
  @@index([isConversion])
  @@index([sessionId, eventType])
  @@index([eventType, timestamp])
  @@index([isConversion, timestamp])
  @@index([variantId, isConversion])
}

model AIOptimization {
  id          String           @id @default(cuid())
  type        OptimizationType
  prompt      String
  context     Json?
  suggestions Json
  applied     Boolean          @default(false)
  model       String
  tokensUsed  Int?
  createdAt   DateTime         @default(now())

  @@index([type])
  @@index([createdAt])
}

model PersonalizationRule {
  id        String                @id @default(cuid())
  name      String
  segment   Json
  priority  Int                   @default(0)
  action    PersonalizationAction
  config    Json
  isActive  Boolean               @default(true)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([isActive])
}

model Integration {
  id          String          @id @default(cuid())
  workspaceId String
  type        IntegrationType
  name        String
  config      Json
  isActive    Boolean         @default(true)
  lastSyncAt  DateTime?
  lastError   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([type])
}

model ApiKey {
  id         String    @id @default(cuid())
  key        String    @unique
  name       String
  userId     String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique @map("token")
  expires      DateTime @map("expiresAt")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken], map: "Session_token_idx")
  @@index([userId])
}

model Webhook {
  id          String            @id @default(cuid())
  url         String
  events      String[]
  secret      String?
  active      Boolean           @default(true)
  workspaceId String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  workspace   Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]

  @@index([workspaceId])
}

model WebhookDelivery {
  id             String    @id @default(cuid())
  webhookId      String
  event          String
  payload        Json
  status         String
  attempts       Int       @default(0)
  lastAttemptAt  DateTime?
  responseStatus Int?
  responseBody   String?
  error          String?
  createdAt      DateTime  @default(now())
  webhook        Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([webhookId, status])
  @@index([webhookId, createdAt])
  @@index([status, lastAttemptAt])
}

model PageVersion {
  id             String     @id @default(cuid())
  pageId         String
  versionNumber  Int
  title          String
  description    String?
  content        Json
  metadata       Json?
  changeType     ChangeType @default(MANUAL_SAVE)
  changeSummary  String?
  changedBy      String
  isRestorePoint Boolean    @default(false)
  createdAt      DateTime   @default(now())
  page           Page       @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, versionNumber])
  @@index([pageId])
  @@index([pageId, createdAt])
  @@index([pageId, versionNumber])
}

model CollaborationSession {
  id                  String    @id @default(cuid())
  pageId              String
  userId              String
  userName            String
  userAvatar          String?
  color               String
  isActive            Boolean   @default(true)
  lastSeenAt          DateTime  @default(now())
  cursorX             Int?
  cursorY             Int?
  selectedComponentId String?
  socketId            String?
  startedAt           DateTime  @default(now())
  endedAt             DateTime?

  @@index([pageId])
  @@index([pageId, isActive])
  @@index([userId])
  @@index([socketId])
}

model PageEdit {
  id          String    @id @default(cuid())
  pageId      String
  componentId String?
  userId      String
  editType    EditType
  path        String
  oldValue    Json?
  newValue    Json?
  version     Int
  appliedAt   DateTime?
  conflicted  Boolean   @default(false)
  resolvedBy  String?
  createdAt   DateTime  @default(now())

  @@index([pageId])
  @@index([pageId, createdAt])
  @@index([componentId])
  @@index([userId])
}

model PageTranslation {
  id             String            @id @default(cuid())
  pageId         String
  locale         String
  title          String
  description    String?
  seoTitle       String?
  seoDescription String?
  components     Json
  status         TranslationStatus @default(DRAFT)
  translatedBy   String?
  reviewedBy     String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  page           Page              @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, locale])
  @@index([pageId])
  @@index([locale])
  @@index([status])
}

model SupportedLocale {
  id          String   @id @default(cuid())
  workspaceId String
  code        String
  name        String
  isDefault   Boolean  @default(false)
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@unique([workspaceId, code])
  @@index([workspaceId])
  @@index([workspaceId, isEnabled])
}

model Element {
  id            String      @id @default(cuid())
  pageId        String
  variantId     String?

  // Element Definition
  type          String      // PrimitiveType or ComponentType
  name          String
  order         Int

  // Hierarchy
  parentId      String?     // Parent element ID for nesting
  depth         Int         @default(0)
  path          String      // Materialized path for tree queries

  // Content & Styles
  content       Json?       @db.JsonB // Primitive content (text, image url)
  styles        Json        @db.JsonB // Tailwind classes + custom styles
  stateStyles   Json?       @db.JsonB // Hover/focus/active styles

  // Metadata
  locked        Boolean     @default(false)
  hidden        Boolean     @default(false)
  className     String?
  attributes    Json?

  // AI
  aiPrompt      String?     @db.Text
  aiGenerated   Boolean     @default(false)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  page          Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  variant       PageVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  parent        Element?    @relation("ElementHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children      Element[]   @relation("ElementHierarchy")

  @@index([pageId])
  @@index([parentId])
  @@index([order])
  @@index([pageId, order])
  @@index([path])

}

// ============================================================================
// INVITE SYSTEM & WAITLIST
// ============================================================================

model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  maxUses     Int       @default(1)
  usedCount   Int       @default(0)
  expiryDate  DateTime?
  createdBy   String?   // Admin User ID
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
}

model WaitlistUser {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String?
  
  // Viral Mechanics
  referralCode String   @unique // Generated unique code for this user
  referredBy   String?  // The referralCode of the person who referred them
  referralCount Int     @default(0)
  
  // Position
  position    Int       @default(0) // Logic handled in app/db triggers usually
  
  status      WaitlistStatus @default(PENDING)
  invitedAt   DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@index([referralCode])
  @@index([status])
}

enum WaitlistStatus {
  PENDING
  INVITED
  REGISTERED
  REMOVED
}

enum SystemRole {
  USER
  ADMIN
}

// DESIGN SYSTEM - Design tokens per workspace
model DesignSystem {
  id           String    @id @default(cuid())
  workspaceId  String    @unique
  name         String    @default("Default")
  colors       Json
  typography   Json
  spacing      Json
  borderRadius Json
  shadows      Json
  breakpoints  Json
  customTokens Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model CustomDomain {
  id          String             @id @default(cuid())
  workspaceId String
  domain      String             @unique
  status      CustomDomainStatus @default(PENDING)
  dnsRecords  Json?
  verifiedAt  DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([domain])
}

model CustomFont {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  family      String
  weight      Int[]
  style       String[]
  woff2Url    String?
  woffUrl     String?
  ttfUrl      String?
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, family])
  @@index([workspaceId])
}



enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum ComponentType {
  HERO
  CTA
  PRICING
  FEATURES
  TESTIMONIALS
  FAQ
  FORM
  NEWSLETTER
  HEADER
  FOOTER
  CUSTOM
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TemplateCategory {
  HERO
  LANDING_PAGE
  PRICING
  DEMO
  FUNNEL
  WAITLIST
  COMING_SOON
}

enum TestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  ARCHIVED
}

enum EventType {
  PAGE_VIEW
  CLICK
  FORM_SUBMIT
  SCROLL
  TIME_ON_PAGE
  CONVERSION
  CUSTOM
}

enum OptimizationType {
  VARIANT_GENERATION
  SEO_OPTIMIZATION
  CONTENT_PERSONALIZATION
  HEADLINE_SUGGESTIONS
  CTA_OPTIMIZATION
}

enum PersonalizationAction {
  SWAP_COMPONENT
  CHANGE_TEXT
  CHANGE_IMAGE
  REDIRECT
  SHOW_BANNER
}

enum IntegrationType {
  STRIPE
  HUBSPOT
  SALESFORCE
  MAILCHIMP
  ZAPIER
  WEBHOOK
  GOOGLE_ANALYTICS
  FACEBOOK_PIXEL
}

enum ChangeType {
  MANUAL_SAVE
  AUTO_SAVE
  PUBLISHED
  ROLLBACK
  COLLABORATION_MERGE
}

enum EditType {
  COMPONENT_ADD
  COMPONENT_UPDATE
  COMPONENT_DELETE
  COMPONENT_REORDER
  PAGE_UPDATE
  STYLE_UPDATE
  CONTENT_UPDATE
}

enum TranslationStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
}

enum CustomDomainStatus {
  PENDING
  ACTIVE
  FAILED
}


